<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Step 1: Collect Show Commands &mdash; LTRATO-2001  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Step 2: Writting Test Script" href="step2.html" />
    <link rel="prev" title="Task 2: Writting Initial Scripts" href="index.html" /> <link href="../../_static/style.css" rel="stylesheet" type="text/css"> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> LTRATO-2001<img src="../../_static/CL-2022.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#learning-objetives">Learning Objetives</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../labaccess/index.html">Lab Access</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../labaccess/index.html#ip-addressing-and-access-information">IP Addressing and Access Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labaccess/index.html#component-details">Component Details</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../labaccess/index.html#get-started">Get Started</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tasks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../task1/index.html">Task 1: Exploring and Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../task1/step1.html">Step 1: Explore Lab Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task1/step2.html">Step 2: Verify pyATS Testbed File</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task1/step3.html">Step 3: pyATS Capabilities using the pyATS Shell</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Task 2: Writting Initial Scripts</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Step 1: Collect Show Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="step2.html">Step 2: Writting Test Script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../task3/index.html">Task 3: Verification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../task3/step1.html">Step 1: Verify Log Messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task3/step2.html">Step 2: Verify the Service Contracts Coverage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task3/step3.html">Step 3: Verify the Routing Information using Parsers and pyATS Learn</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task3/step4.html">Step 4: Run PING to Verify Reachability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../task4/index.html">Task 4: Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../task4/step1.html">Step 1: Show the Results of Tests in a Browser</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task4/step2.html">Step 2: TBD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task4/step3.html">Step 3: TBD</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../task5/index.html">Task 5: TBD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../task5/step1.html">Step 1: TBD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task5/step2.html">Step 2: TBD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task5/step3.html">Step 3: TBD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../task5/step4.html">Step 4: TBD</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conclusions.html">Conclusions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Appendix: Installing Pre-Requisites</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../appendix.html#install-docker">Install Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../appendix.html#install-git">Install Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../appendix.html#install-anx">Install anx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../appendix.html#install-postman">Install Postman</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LTRATO-2001</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Tasks</a> &raquo;</li>
          <li><a href="index.html">Task 2: Writting Initial Scripts</a> &raquo;</li>
      <li>Step 1: Collect Show Commands</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/CiscoLive2021/HOLPRG-2002/blob/master/docs/tasks/task2/step1.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="step-1-collect-show-commands">
<h1>Step 1: Collect Show Commands<a class="headerlink" href="#step-1-collect-show-commands" title="Permalink to this headline">¶</a></h1>
<p><strong>Value Proposition:</strong> In this task, we will use the knowledge we have gained from the previous task to write a script that collects <strong>show inventory</strong> command from each device in the testbed. The output of this command will be saved in the file, created by the script collected_task4. These outputs can be used later if you want to compare the future state of the network with the current one. Since it’s required to collect outputs from all the devices in the testbed, in this task we will work with the <strong>testbed.devices</strong> object, and iterate over all the devices contained in this object to collect an output of the required commands from each device.</p>
<ol class="arabic">
<li><p>Let’s connect to pyATS and check parts of the code before running the final script. In the beginning, we will check the structure of <strong>testbed.devices</strong> object.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pyats</span> <span class="n">shell</span> <span class="o">--</span><span class="n">testbed</span><span class="o">-</span><span class="n">file</span> <span class="n">pyats_testbed</span><span class="o">.</span><span class="n">yaml</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testbed</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Check the output</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>TopologyDict<span class="o">({</span><span class="s1">&#39;asav-1&#39;</span>: &lt;Device asav-1 at 0x7f60bef1da90&gt;, <span class="s1">&#39;csr1000v-1&#39;</span>: &lt;Device csr1000v-1 at 0x7f60beee73d0&gt;, <span class="s1">&#39;nx-osv-1&#39;</span>: &lt;Device nx-osv-1 at 0x7f60bda8d850&gt;<span class="o">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As you can see from the output in the previous step, ‘Device &lt;device_name&gt;’ objects are contained as dictionary values in the object of TopologyDict class. The device names are used as dictionary keys.</p>
</div>
</div></blockquote>
</li>
<li><p>In this task we will apply standard dictionary method: <strong>items()</strong> to get <strong>keys</strong> (device names) and <strong>values</strong> (respective device objects). For iteration, the for loop will be used:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># device_name - stores hostname of a device</span>
<span class="c1"># device - stores device object</span>
<span class="k">for</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">testbed</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">device</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># device.execute() method - will used to get the output of &quot;show inventory&quot; command</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">device</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show inventory&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##########################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Python uses Indentation (the spaces at the beginning of a code line) to specify code blocks. The indentation is important because it determines the scope of the code.</p>
</div>
<a class="reference internal image-reference" href="../../_images/indentation-example.png"><img alt="../../_images/indentation-example.png" class="align-center" src="../../_images/indentation-example.png" style="width: 75%;" /></a>
</div></blockquote>
</li>
<li><p>Paste the following snippet to pyATS console:</p>
<blockquote>
<div><ul>
<li><p>Place the following iPython command in the beginning of code:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">cpaste</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Copy and paste the code into the pyATS console:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unicon.core.errors</span> <span class="kn">import</span> <span class="n">EOF</span><span class="p">,</span> <span class="n">SubCommandFailure</span>
<span class="k">for</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">testbed</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#########################&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#####device_name = </span><span class="si">{device_name}</span><span class="s1">, device = </span><span class="si">{device}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;#####device_name = </span><span class="si">{device_name}</span><span class="s1">, device_object_type = {type(device)}&#39;</span><span class="p">)</span>
    <span class="n">device</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">log_stdout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####Output:&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show inventory&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{out}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SubCommandFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__cause__</span><span class="p">,</span> <span class="n">EOF</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection closed, try reconnect&#39;</span><span class="p">)</span>
            <span class="n">device</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="n">device</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>End the code with <code class="docutils literal notranslate"><span class="pre">--</span></code></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check the result of this code. Now each device should return the output of <strong>show inventory</strong> command.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a device connection is closed or terminated unexpectedly after it has already connected to a device, there will be multiple errors generated (for example, the Python EOF exception would be invoked) at the time of command execution.
To handle this situation, it’s required to add the following code to reconnect to a device in case a broken connection to a device has been detected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unicon.core.errors</span> <span class="kn">import</span> <span class="n">EOF</span><span class="p">,</span> <span class="n">SubCommandFailure</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">device</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show inventory&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">SubCommandFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__cause__</span><span class="p">,</span> <span class="n">EOF</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection closed, try reconnect&#39;</span><span class="p">)</span>
        <span class="n">device</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="n">device</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>Exit the pyATS shell by using the <strong>exit</strong> command. Now we are ready to go through the final version of the script gathering commands specified from all the devices in the testbed and saving them to file on Linux (proceed to the next step).</p></li>
<li><p>Open the prepared script task4_labpyats.py in Nano editor.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nano task4_labpyats.py
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Before diving into the details of the code, study the explanation of the code given below. The script <strong>task4_labpyats.py</strong> has the following Python functions:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Function</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>def main()</p></td>
<td><p>The main function (see “1” on the illustration that follows). It calls the collect_device_commands function (see “2”).</p></td>
</tr>
<tr class="row-odd"><td><p>def collect_device_commands( command_to_gather, output_filename)</p></td>
<td><p>pyATS job file to run tests from Task 10</p></td>
</tr>
<tr class="row-even"><td><p>Task4_labpyats.py</p></td>
<td><p>The function that does most of the job. The main tasks this function performs include the following:</p>
<p>1.	Iterates over devices - see “3” (in the way it has been done in the previous steps). For each device:</p>
<p>2.	Connects to the device (see “4”).</p>
<p>3.	Writes output of the commands for this device to a file – see “5”.</p>
</td>
</tr>
<tr class="row-odd"><td><p>def write_commands_to_file(abs_filename, command_output)</p></td>
<td><p>This is a supplementary function and it’s used to write the output of commands to a file (see “5”).</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To simplify the script, the name of the testbed is hard-coded into the main():
<strong>testbed_filename = ‘/home/cisco/labpyats/pyats_testbed.yaml’</strong>
In further scripts, the name of a testbed file will be input as a parameter of the script.</p>
</div>
<a class="reference internal image-reference" href="../../_images/code-structure.png"><img alt="../../_images/code-structure.png" class="align-center" src="../../_images/code-structure.png" style="width: 75%;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>log_stdout=False</strong> option in <strong>device.connect</strong> call:
<strong>device.connect(log_stdout=False)</strong>
It will disable all logging to a screen for the whole connection session to this device (until disconnection takes place or until log_stdout is set to <strong>True</strong>).
For the script collecting many commands, it would be preferred to prune the output of the commands to the console using this method.</p>
</div>
</div></blockquote>
</li>
<li><p>Exit Nano without saving, pressing:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Ctrl + X
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Now run the script:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python task4_labpyats.py
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Check that there is a new file created: collected_task4. Check the time when it was created.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls -l ~/labpyats <span class="p">|</span> grep collected_task4
</pre></div>
</div>
<p>Sample output in Bash shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-rw-r--r-- <span class="m">1</span> cisco cisco  <span class="m">6</span>.9K Nov  <span class="m">5</span> <span class="m">17</span>:12 collected_task4
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Check content of collected_task4 file.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat ~/labpyats/collected_task4
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<p><em>Section author: Luis Rueda &lt;<a class="reference external" href="mailto:lurueda&#37;&#52;&#48;cisco&#46;com">lurueda<span>&#64;</span>cisco<span>&#46;</span>com</a>&gt;, Jairo Leon &lt;<a class="reference external" href="mailto:jaileon&#37;&#52;&#48;cisco&#46;com">jaileon<span>&#64;</span>cisco<span>&#46;</span>com</a>&gt;</em></p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Task 2: Writting Initial Scripts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="step2.html" class="btn btn-neutral float-right" title="Step 2: Writting Test Script" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Cisco Systems, Inc. 2020.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>